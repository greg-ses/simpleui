<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" encoding="utf-8">
<head>
    <title>CallQueueTest</title>
    <link rel="stylesheet" type="text/css" href="../../dojo-toolkit/dojo/resources/dojo.css" />
    <link rel="stylesheet" type="text/css" href="../../dojo-toolkit/dijit/themes/soria/soria.css" />
    <script type="text/javascript">
        // djConfig must be set before any dojo scripts are loaded
        var djConfig = {
            isDebug: false,
            parseOnLoad: true,
            modulePaths: { 'ppcJs': '../../ppcJs' }
        };
    </script>
    <script type="text/javascript" src="../../dojo-toolkit/dojo/dojo.js"></script>
    <script type="text/javascript">
        dojo.provide('ppcJs.tests.CallQueueTestHTML');
        dojo.require('dojo.parser');
        dojo.require('doh.runner');
        dojo.require('dojo.robot');
        dojo.require('ppcJs.bizLogic.generic.CallQueue');

        var testCaseTimeout = 20000;
        var perActionPause = 600;   // longer than default to verify configuration
        var configPause = 700;
        var assertPause = 2000;

        dojo.addOnLoad(function () {
            doh.register('ppcJs.tests.CallQueueTest', [
                    function testSynchronousCall(t) {
                        var semaphore = true;
                        var semaphoreGetter = function () {
                            return false;
                        };

                        var semaphoreSetter = function (newValue) {
                            semaphore = newValue;
                        };

                        // where outside call would be writeMessage: function(arg1, arg2) {}
                        var _writeMessage = function (argArray) {
                            var sutNode = dojo.byId('sutContainer');
                            sutNode.innerHTML = argArray[0] + argArray[1];
                        };

                        var sut = new ppcJs.bizLogic.generic.CallQueue(this, semaphoreGetter, semaphoreSetter).push(_writeMessage, ['a', 'b']);

                        var sutNode = dojo.byId('sutContainer');
                        t.assertEqual('ab', sutNode.innerHTML);
                        t.assertFalse(semaphore);
                    },

                    {
                        // note: only valid for cases where semaphore cleared before CallQueue._delayMs
                        name: "AsyncCallWithFixedDelay",
                        timeout: testCaseTimeout,

                        setUp: function () {
                            var sutContainer = dojo.byId('sutContainer');
                            sutContainer.innerHTML = "";
                        },

                        runTest: function () {
                            var d = new doh.Deferred();

                            var semaphoreGetter = function () {
                                return true;
                            };

                            var semaphoreSetter = function (id) {
                            };

                            var writeMessage = function (argArray) {
                                var sutNode = dojo.byId('sutContainer');
                                sutNode.innerHTML = argArray[0] + argArray[1];
                            };

                            var sut = new ppcJs.bizLogic.generic.CallQueue(this, semaphoreGetter, semaphoreSetter, null, configPause).push(writeMessage, ['a', 'b']);

                            setTimeout(dojo.hitch(this, function () {
                                //semaphore = false;
                                var sutNode = dojo.byId('sutContainer');
                                sutNode.innerHTML = '';
                            }), perActionPause);

                            doh.robot.sequence(function () {
                                var sutNode = dojo.byId('sutContainer');
                                var resultCorrect = (sutNode.innerHTML == 'ab');
                                if (resultCorrect) {
                                    d.callback(true);
                                }
                                else {
                                    d.errback(new Error('result (' + sutNode.innerHTML + ') incorrect'));
                                }
                            }, assertPause);

                            return d;
                        }
                    }

                ]);
            //Execute D.O.H. in this remote file.
            doh.run();
        });
    </script>
</head>
<body class="soria">
    <!-- place to insert sut. -->
    <div id="sutContainer" style="width: 800px; height: 400px">
    </div>
    <div id="mouseOutArea" style="width: 300px; height: 100px">
        <br />
    </div>
</body>
</html>

