<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>ExtendedSelectTest</title>
    <link rel="stylesheet" type="text/css" href="../../dojo-toolkit/dojo/resources/dojo.css" />
    <link rel="stylesheet" type="text/css" href="../../dojo-toolkit/dijit/themes/soria/soria.css" />
    <script type="text/javascript">
        // djConfig must be set before any dojo scripts are loaded
        var djConfig = {
            isDebug: false,
            parseOnLoad: true,
            modulePaths: { 'ppcJs': '../../ppcJs' }
        };
    </script>
    <script type="text/javascript" src="../../dojo-toolkit/dojo/dojo.js"></script>
    <script type="text/javascript">
        dojo.provide('ppcJs.tests.ExtendedSelectTestHTML');
        dojo.require('dojo.parser');
        dojo.require('doh.runner');
        dojo.require('dojo.robot');
        dojo.require('ppcJs.widget.ExtendedSelect');
        dojo.require('ppcJs.widget.extendedSelect.esDto');
        dojo.require('ppcJs.tests.ScriptTestUtilities');

        var testCaseTimeout = 10000;
        var perActionPause = 200;
        var assertPause = 2000;

        dojo.addOnLoad(function () {
            doh.register('ppcJs.tests.ExtendedSelectTest', [
                    {
                        name: "SelectRefOption",
                        timeout: testCaseTimeout,

                        setUp: function () {
                            var sutContainer = dojo.byId('sutContainer');
                            sutContainer.innerHTML = "";
                        },

                        runTest: function () {
                            var d = new doh.Deferred();
                            var name = 'testSelect';
                            var options = ['charge', 'strip', 'PARAM_UPDATE', 'custom'];
                            var optionsObj = new Array();
                            for (var k = 0; k < options.length; k++) {
                                optionsObj.push({ value: options[k], label: options[k] });
                            }

                            var extensionRefs = [null, null, 'param', 'customCmd'];
                            var ctorObj = {
                                options: optionsObj,
                                title: name
                            };

                            dojo.mixin(ctorObj, new ppcJs.widget.extendedSelect.esDto.Ctor(extensionRefs));
                            var sut = new ppcJs.widget.ExtendedSelect(ctorObj);

                            var resultValue = '';
                            var resultIndex = 0;
                            var resultRefs = '';
                            var handler = dojo.connect(sut, 'onExtendedChange', function (newValue, i, refs) {
                                resultValue = newValue;
                                resultRefs = refs;
                                resultIndex = i;
                            });

                            dojo.place(sut.domNode, 'sutContainer');

                            // select PARAM_UPDATE (select[2])
                            doh.robot.mouseMoveAt(sut.domNode, perActionPause);
                            doh.robot.mouseClick({ left: true }, perActionPause);
                            doh.robot.keyPress(dojo.keys.DOWN_ARROW, perActionPause);
                            doh.robot.keyPress(dojo.keys.DOWN_ARROW, perActionPause);
                            doh.robot.keyPress(dojo.keys.ENTER, perActionPause);

                            doh.robot.sequence(function () {
                                var validValue = (resultValue == 'PARAM_UPDATE');
                                var validRefs = true;
                                for (var j = 0; j < extensionRefs.length; j++) {
                                    if (extensionRefs[j] != resultRefs[j]) {
                                        validRefs = false;
                                        break;
                                    }
                                }
                                var validIndex = (resultIndex == 2);

                                if (validValue && validRefs && validIndex) {
                                    d.callback(true);
                                }
                                else {
                                    d.errback(new Error('incorrect event args'));
                                }
                            }, assertPause);

                            return d;
                        }
                    },

                    function testTriggerExtendedChangeEvent(t) {
                        var sutContainer = dojo.byId('sutContainer');
                        sutContainer.innerHTML = "";
                        var name = 'testSelect';
                        var options = ['charge', 'strip', 'PARAM_UPDATE', 'custom'];
                        var optionsObj = new Array();
                        for (var k = 0; k < options.length; k++) {
                            optionsObj.push({ value: options[k], label: options[k] });
                        }

                        var extensionRefs = [null, null, 'param', 'customCmd'];
                        var ctorObj = {
                            options: optionsObj,
                            title: name
                        };

                        dojo.mixin(ctorObj, new ppcJs.widget.extendedSelect.esDto.Ctor(extensionRefs));
                        sut = new ppcJs.widget.ExtendedSelect(ctorObj);

                        var resultValue = '';
                        var resultIndex = 0;
                        var resultRefs = '';
                        var handler = dojo.connect(sut, 'onExtendedChange', function (newValue, i, refs) {
                            resultValue = newValue;
                            resultRefs = refs;
                            resultIndex = i;
                        });

                        dojo.place(sut.domNode, 'sutContainer');
                        sut.triggerExtendedChangeEvent();

                        t.assertTrue(resultValue == 'charge', 'incorrect select value');

                        var validRefs = true;
                        for (var j = 0; j < extensionRefs.length; j++) {
                            if (extensionRefs[j] != resultRefs[j]) {
                                validRefs = false;
                                break;
                            }
                        }
                        t.assertTrue(validRefs, 'incorrect widget list for ref');
                        t.assertTrue(resultIndex == 0, 'incorrect select index');
                    }

                ]);
            //Execute D.O.H. in this remote file.
            doh.run();
        });
    </script>
</head>
<body class="soria">
    <!-- place to insert sut. -->
    <div id="sutContainer" style="width: 800px; height: 400px">
    </div>
    <div id="mouseOutArea" style="width: 300px; height: 100px">
        <br />
    </div>
</body>
</html>

