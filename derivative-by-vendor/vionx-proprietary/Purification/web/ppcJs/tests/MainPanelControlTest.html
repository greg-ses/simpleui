<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>DiagramBlockControl test</title>
    <link rel="stylesheet" type="text/css" href="../../dojo-toolkit/dojo/resources/dojo.css" />
    <link rel="stylesheet" type="text/css" href="../../dojo-toolkit/dijit/themes/soria/soria.css" />
    <link rel="stylesheet" type="text/css" href="../themes/mainPanelControl/mainPanelControl.css" />

    <script type="text/javascript">
        // djConfig must be set before any dojo scripts are loaded
        var djConfig = {
            isDebug: false,
            parseOnLoad: true,
            modulePaths: { 'ppcJs': '../../ppcJs' }
        };
    </script>

    <script type="text/javascript" src="../../dojo-toolkit/dojo/dojo.js"></script>
    <script type="text/javascript">
        dojo.provide("ppcJs.tests.MainPanelControlTestHTML");
        dojo.require("dojo.parser");
        dojo.require("doh.runner");
        dojo.require("dojo.robot");
        dojo.require("dojox.collections.Dictionary");
        dojo.require('ppcJs.utilities.Store');
        dojo.require("ppcJs.utilities.AccessControl");
        dojo.require("ppcJs.MainPanelControl");
        dojo.require("ppcJs.tests.ParamControlTestUtilities");

        var testTimeout = 7000;
        var testPause = 50;
        var sysControlAuth = [ppcJs.utilities.AccessControl.Task.GeneralView, ppcJs.utilities.AccessControl.Task.SystemControl];

        function getModeMap() {
            var modeMap = new dojox.collections.Dictionary();
            modeMap.add(1, 'charge');
            modeMap.add(2, 'discharge');
            return modeMap;
        }


        dojo.addOnLoad(function () {
            doh.register("ppcJs.tests.MainPanelControlViewTest", [
                    function testCreateMainPanelControl(t) {
                        var sutContainer = dojo.byId("sutContainer");
                        var modeMap = getModeMap();
                        var urlInfo = ppcJs.tests.ParamControlTestUtilities.getUrlInfo();
                        var queryId = 1;
                        var ctorDto1 = new ppcJs.MpcDto.Ctor(urlInfo, sysControlAuth, queryId, modeMap, true);
                        var sut1 = new ppcJs.MainPanelControl(ctorDto1);
                        dojo.place(sut1.domNode, "sutContainer");

                        var userAuths2 = [ppcJs.utilities.AccessControl.Task.GeneralView];
                        var ctorDto2 = new ppcJs.MpcDto.Ctor(urlInfo, userAuths2, queryId, modeMap, true);
                        var sut2 = new ppcJs.MainPanelControl(ctorDto2);
                        dojo.place(sut2.domNode, "sutContainer");

                        var refEstop = true;
                        var refAuto = false;
                        var refLock = false;
                        var dto1 = new ppcJs.MpcDto.Update(2, -5, refEstop, refAuto, refLock);
                        sut1.update(dto1);

                        var dto2 = new ppcJs.MpcDto.Update(1, 10, refEstop, refAuto, refLock);
                        sut2.update(dto2);

                        // note: dijit select uses string values
                        var setMode = sut1._modeSelect.get('value');
                        t.assertEqual('2', setMode);
                        t.assertEqual('charge', sut2._modeVal.innerHTML);

                        var estop1 = sut1._estopToggle.get('checked');
                        var auto1 = sut1._autoSlider.get('value');
                        var lock1 = sut1._lockSlider.get('value');
                        t.assertEqual(refEstop, estop1, 'estop1 != refEstop1');
                        t.assertEqual(refAuto, auto1, 'auto1 != refAuto1');
                        t.assertEqual(refLock, lock1, 'lock1 != refLock1');
                    },

                    {
                        name: "SetEstop",
                        timeout: testTimeout,

                        setUp: function () {
                            var sutContainer = dojo.byId("sutContainer");
                            sutContainer.innerHTML = "";
                        },

                        runTest: function () {
                            var d = new doh.Deferred();

                            var sutContainer = dojo.byId("sutContainer");
                            var modeMap = getModeMap();
                            var urlInfo = ppcJs.tests.ParamControlTestUtilities.getUrlInfo();
                            var queryId = 2;

                            var sut = new ppcJs.MainPanelControl({ authTasks: sysControlAuth,
                                modeMap: modeMap,
                                urlInfo: urlInfo,
                                isMaster: true,
                                queryId: queryId
                            });
                            dojo.place(sut.domNode, "sutContainer");

                            var refEstop = true;
                            var refAuto = false;
                            var refLock = false;
                            var dto = new ppcJs.MpcDto.Update(2, -5, refEstop, refAuto, refLock);
                            sut.update(dto);

                            // click on EStop
                            doh.robot.mouseMoveAt(sut._estopToggle.domNode, testPause);
                            doh.robot.mouseClick({ left: true }, testPause);

                            doh.robot.sequence(function () {
                                if (true) {
                                    d.callback(true);
                                }
                            }, 600);

                            return d;
                        }
                    },

                    function testCreateBlockMainPanelControl(t) {
                        var sutContainer = dojo.byId("sutContainer");
                        sutContainer.innerHTML = "";

                        var modeMap = getModeMap();
                        var urlInfo = ppcJs.tests.ParamControlTestUtilities.getUrlInfo();
                        var queryId = 1;
                        var blockControlAuth = [ppcJs.utilities.AccessControl.Task.GeneralView,
                            ppcJs.utilities.AccessControl.Task.SystemControl,
                            ppcJs.utilities.AccessControl.Task.ComponentControl
                            ];

                        var sut1 = new ppcJs.MainPanelControl({ authTasks: sysControlAuth,
                            modeMap: modeMap,
                            urlInfo: urlInfo,
                            isMaster: false,
                            queryId: queryId
                        });
                        dojo.place(sut1.domNode, "sutContainer");

                        var sut2 = new ppcJs.MainPanelControl({ authTasks: blockControlAuth,
                            modeMap: modeMap,
                            urlInfo: urlInfo,
                            isMaster: false,
                            queryId: queryId
                        });
                        dojo.place(sut2.domNode, "sutContainer");

                        var refEstop = true;
                        var refAuto = false;
                        var dto = new ppcJs.MpcDto.Update(2, -5, refEstop, refAuto);
                        sut1.update(dto);
                        sut2.update(dto);
                    }
                ]);
            //Execute D.O.H. in this remote file.
            doh.run();
        });
    </script>
</head>
<body class="soria">
    <!-- place to insert sut. -->
    <div id="sutContainer" style="width: 300px">
    </div>
    <div id="mouseOutArea" style="width: 300px; height: 100px">
        <br />
    </div>
</body>
</html>
