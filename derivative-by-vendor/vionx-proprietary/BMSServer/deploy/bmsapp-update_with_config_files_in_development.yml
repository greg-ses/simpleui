---
# use flag --extra-vars "remupdate=true" to complete the distribution to all VECs.
# Without the flag set the packages are created and copied to the BMS server staging area only.
- hosts: all
  vars:
    app_name: vecpackage-bmsapp
  remote_user: "{{ lookup('env', 'REMOTE_WEB_USER') }}"
  tasks:
  - include_vars:
      file: commonvars.yml
  - name: Prep Local Staging Area
    local_action: file path={{ unit_config_source_dir }} state=absent
  - local_action: file path={{ unit_config_source_dir }} state=directory mode=0755
  - name: Prep BMS Target Staging Area
    file:
      path: "{{ bms_stage_dir }}"
      state: directory
      mode: 0777

  - name: Copy Binary To Local Stage Area
    copy: src={{ bms_binary_source_dir }}/{{ bms_app_binary }} dest={{ bms_stage_dir }}/{{ bms_app_binary }}

  - name: Backup Existing Binary
    command: cp /opt/bin/{{ bms_app_binary }} {{ archive_dir }}/{{ bms_app_binary }}{{ archive_suffix }}

  - name: Stop application service
    service:
      name: bms
      state: stopped
    become: true

  - name: Deploy binary
    command: install -D {{ bms_stage_dir }}/{{ bms_app_binary }} /opt/bin/{{ bms_app_binary }}

  - name: Get binary md5
    command: md5sum /opt/bin/{{ bms_app_binary }}
    register: md5output
  - debug: msg="{{ md5output.stdout }}"
  - name: Set executable permissions
    file:
      path: /opt/bin/{{ bms_app_binary }}
      state: file
      mode: 0777

  - name: Copy Properties files to staging area
    copy: src={{ bms_properties_source_dir }}/BMS_io.properties dest={{ bms_stage_dir }}/BMS_io.properties
  - copy: src={{ bms_properties_source_dir }}/bms_thermal.properties dest={{ bms_stage_dir }}/bms_thermal.properties
  - copy: src={{ bms_properties_source_dir }}/BMSServer.properties dest={{ bms_stage_dir }}/BMSServer.properties

  - name: Backup existing properties files
    command: cp /opt/config/*.properties {{ archive_dir }}/.

  - name: Deploy new properties files
    command: install -D {{ bms_stage_dir }}/BMS_io.properties /opt/config/BMS_io.properties
  - command: install -D {{ bms_stage_dir }}/bms_thermal.properties /opt/config/bms_thermal.properties
  - command: install -D {{ bms_stage_dir }}/BMSServer.properties /opt/config/BMSServer.properties

  - name: Start application service
    service:
      name: bms
      state: started
    become: true

#TODO make application into a service for easier management and startup detection
