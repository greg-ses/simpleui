---
- hosts: all
  vars:
    local_stage_dir: /tmp/proxy-staging-local
    remote_stage_dir: /tmp/proxy-staging-remote
    bundle_file: proxy-web-setup-bundle.tgz
    web_deploy_dir: /var/www/device
    archive_dir: /vionx
    vec_mount_opts: user=service,password=,iocharset=utf8,auto,nofail
  remote_user: service 
  tasks:
  - name: 'Remove old web packages'
    local_action: command rm -rf {{ local_stage_dir }}

  - name: Unmount VEC c1-smu Data
    mount:
      path: "{{ web_deploy_dir }}/c1-smu-dat"
      state: unmounted

  - name: Unmount VEC c1-vcu Data
    mount:
      path: "{{ web_deploy_dir }}/c1-vcu-dat"
      state: unmounted

  - name: Unmount VEC c1-scu-a1 Data
    mount:
      path: "{{ web_deploy_dir }}/c1-scu-a1-dat"
      state: unmounted

  - name: Unmount VEC c1-scu-a2 Data
    mount:
      path: "{{ web_deploy_dir }}/c1-scu-a2-dat"
      state: unmounted

  - name: Unmount VEC c1-scu-b1 Data
    mount:
      path: "{{ web_deploy_dir }}/c1-scu-b1-dat"
      state: unmounted

  - name: Unmount VEC c1-scu-b2 Data
    mount:
      path: "{{ web_deploy_dir }}/c1-scu-b2-dat"
      state: unmounted

  - name: Backup {{ web_deploy_dir }}
    command: cp -rf {{ web_deploy_dir }} {{ archive_dir }}
  - name: Backup fstab
    command: cp /etc/fstab {{ archive_dir }}/fstab_bak

#  - name: 'Create local staging directory'
#    local_action: command mkdir {{ local_stage_dir }}
  - name: 'Create web packaging application'
    local_action: script create-proxy-web-setup-bundle.sh {{ local_stage_dir }}
  - name: 'Remove old remote staging area folder'
    file:
      path: "{{ remote_stage_dir }}"
      state: absent
  - name: 'Create remote staging area folder'
    file:
      path: "{{ remote_stage_dir }}"
      state: directory
#  - name: 'Recreate remote stage area folder'
#    local_action: command mkdir {{ stage_dir }} xxx these are remote actions
  - name: 'Copy bundle'
    copy: src=/tmp/{{ bundle_file }} dest=/tmp/{{ bundle_file }}
  - name: 'Untar bundle into remote stage directory'
    shell: tar xzf /tmp/{{ bundle_file }} -C {{ remote_stage_dir }}
  - name: 'Remove previous deployed web directory'
    file:
      path: "{{ web_deploy_dir }}"
      state: absent
    become: true
  - name: 'Execute remote setup script'
    shell: cd {{ remote_stage_dir }} && ./proxy-web-setup.sh {{ remote_stage_dir }}

  - name: Mount
    block:
      - name: Mount c1-smu
        mount:
          path: "{{ web_deploy_dir }}/c1-smu-dat"
          src: //c1-smu/sys_data
          fstype: cifs
          opts: "{{vec_mount_opts}}"
          state: mounted
        become: true
    rescue:
      - debug:
          msg: "Mount failed, continuing"

  - name: Mount
    block:
      - name: Mount c1-vcu
        mount:
          path: "{{ web_deploy_dir }}/c1-vcu-dat"
          src: //c1-vcu/sys_data
          fstype: cifs
          opts: "{{vec_mount_opts}}"
          state: mounted
        become: true
    rescue:
      - debug:
          msg: "Mount failed, continuing"

  - name: Mount
    block:
      - name: Mount c1-scu-a1
        mount:
          path: "{{ web_deploy_dir }}/c1-scu-a1-dat"
          src: //c1-scu-a1/sys_data
          fstype: cifs
          opts: "{{vec_mount_opts}}"
          state: mounted
        become: true
    rescue:
      - debug:
          msg: "Mount failed, continuing"

  - name: Mount
    block:
      - name: Mount c1-scu-a2
        mount:
          path: "{{ web_deploy_dir }}/c1-scu-a2-dat"
          src: //c1-scu-a2/sys_data
          fstype: cifs
          opts: "{{vec_mount_opts}}"
          state: mounted
        become: true
    rescue:
      - debug:
          msg: "Mount failed, continuing"

  - name: Mount
    block:
      - name: Mount c1-scu-b1
        mount:
          path: "{{ web_deploy_dir }}/c1-scu-b1-dat"
          src: //c1-scu-b1/sys_data
          fstype: cifs
          opts: "{{vec_mount_opts}}"
          state: mounted
        become: true
    rescue:
      - debug:
          msg: "Mount Failed"

  - name: Mount
    block:
      - name: Mount c1-scu-b2
        mount:
          path: "{{ web_deploy_dir }}/c1-scu-b2-dat"
          src: //c1-scu-b2/sys_data
          fstype: cifs
          opts: "{{vec_mount_opts}}"
          state: mounted
        become: true
    rescue:
      - debug:
          msg: "Mount failed, continuing"

  - name: 'Restart apache2'
    service:
      name: apache2
      state: restarted
    become: true
# Cleanup, remove remote staging directory and files
  - name: 'Remove remote staging area folder'
    file:
      path: "{{ remote_stage_dir }}"
      state: absent
    become: true
  - name: 'Remove tar file'
    file:
      path: /tmp/{{ bundle_file }}
      state: absent
    become: true
