<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- 
    TO CONFIGURE FOR DEVELOPMENT/RELEASE BUILD:
    - uncomment corresponding css path link block, comment other block
    - uncomment corresponding dojo-toolkit link(s), comment other block
    - uncomment corresponding dojo.require() block, comment other block

-->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<script type="text/javascript" src="config.js"></script>

    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <script>document.title = _machine_name + " IO"</script>

    <!-- DEVELOPMENT PATHS -->
    <link rel="stylesheet" type="text/css" href="./dojo-toolkit/dojo/resources/dojo.css" />
    <link rel="stylesheet" type="text/css" href="./dojo-toolkit/dijit/themes/soria/soria.css" />
    <link rel="stylesheet" type="text/css" href="./ppcJs/themes/legacyPage.css" />
    <link rel="stylesheet" type="text/css" href="./ppcJs/themes/loadOverlay.css" />
    <link rel="stylesheet" type="text/css" href="./ppcJs/panel/resourceSelect/css/resourceSelect.css" />
    <link rel="stylesheet" type="text/css" href="./ppcJs/panel/io/css/io.css" />
    <link rel="stylesheet" type="text/css" href="./ppcJs/panel/dcServer/css/dcServer.css" />
    <link rel="stylesheet" type="text/css" href="./ppcJs/panel/loadServer/css/loadServer.css" />
    <link rel="stylesheet" type="text/css" href="./ppcJs/control/ajaxStatus/css/ajaxStatus.css" />
    <style type="text/css">
        #leftPane
        {
            padding-top: 30px;
        }
    </style>
</head>
<body class="soria">
    <div id="topNav">
        <div id="innerTopNav">
            <div id="lpResourceNameDiv">
                <span id="pbResourceName"></span>
            </div>
            <div id="lpLinkBar">
                <script>
                document.write("<a href=\"/purification/pumps.html\" class=\"linkBarItem\">Pumps</a>");
                document.write("<a href=\"/purification\" class=\"linkBarItem\">Dashboard</a>");
                document.write("<a href=\"/purification/index.html\" class=\"linkBarItem\">Index</a>");
                </script>
            </div>
            <div id="lpAjaxStatusDiv">
                <div data-dojo-type="ppcJs/control/AjaxStatus">
                </div>
            </div>
            <span id="lpHomeLink"><a href="index.html" class="linkBarItem">
                <img src="./ppcJs/themes/home.jpeg" alt="Home" class="homeLinkImage">
            </a></span>
        </div>
    </div>
    <div id="stackContainer">
        <div id="loadingOverlay" class="loadingOverlay loadingMessage">Loading...</div>
        <div id="lpStack" data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="design:'sidebar'">
			<!--
			<div id="leftPane" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'left', splitter:true">
                <div id="resourceSelect" data-dojo-type="ppcJs/panel/ResourceSelect">
                </div>
            </div> -->
            <div id="stack" data-dojo-type="dijit/layout/TabContainer" region="center" tabposition="top">
                <div id="ioTab" data-dojo-type="dijit/layout/ContentPane" title="I/O" selected="true">
                    <div id="ioPanel" data-dojo-type="ppcJs/panel/Io">
                    </div>
                </div>
              <!--
                <div id="DCServerTab" dojoType="dijit/layout/ContentPane" title="">
                    <div id="DCServerPanel" data-dojo-type="ppcJs/panel/DcServer">
                    </div>
                </div>
                <div id="LoadServerTab" dojoType="dijit/layout/ContentPane" title="">
                    <div id="LoadServerPanel" data-dojo-type="ppcJs/panel/LoadServer">
                    </div>
                </div>
              -->
            </div>
        </div>
    </div>

    <script type="text/javascript" src="config.js"></script>
    <script type="text/javascript">
        // initialize global variables

        // djConfig must be set before any dojo scripts are loaded
        var dojoConfig = {
            selectorEngine: 'acme',     // required for IE9
            async: true,
            isDebug: false,
            parseOnLoad: true,
            locale: 'en-us',
            baseUrl: '/',
            tlmSiblingOfDojo: false,
            packages: [
                { name: 'dojo', location: 'dojo-toolkit/dojo' },
                { name: 'dijit', location: 'dojo-toolkit/dijit' },
                { name: 'dojox', location: 'dojo-toolkit/dojox' },
                { name: 'ppcJs', location: 'ppcJs', main: 'Enum' }
            ],

            ppcServer: {
                demoMode: false,             // true= always go to static local test data
                demoLocalHost: '127.0.100'
            }
        };
    </script>

    <!-- UNCOMMENT EITHER DEVELOPMENT OR RELEASE SCRIPT -->
    <!-- DEVELOPMENT PATH -->
    <script type="text/javascript" src="./dojo-toolkit/dojo/dojo.js"></script>
    <!-- RELEASE PATH 
    <script type="text/javascript" src="./dojo-toolkit/release/dojo/dojo/dojo.js"></script>
    <script type="text/javascript" src="./dojo-toolkit/release/dojo/dijit/dijit.js"></script>
    -->

    <script type="text/javascript">
        require(['dojo/parser', 'dojo/ready'],
        function (parser, ready) {
            ready(function () {
                require(['dojo/_base/lang', 'dojo/dom', 'dojo/aspect', 'dojo/topic', 'dojo/on', 'dojo/io-query', 'dijit/registry',
                    'ppcJs/PubSub', 'ppcJs/utilities/Page'],
                function (lang, dom, aspect, topic, on, ioQuery, registry,
                            PubSub, Page) {
                    Page.hideLoadOverlay('loadingOverlay');

                    // server configuration
                    var resourceServer = 'io';
                    var ioServer = 'io';
                    var dcServer = 'DCServer_cmd';
                    var loadServer = 'LoadServer_cmd';
                    var handlerPath = _ajax_handler;
                    // ID of selected resource (received from server via SystemDiagramPanel template response)
                    var SelectedServerId = '1';
                    var SelectedTabName = 'ioTab';

                    // load panels with page specific query string
                    var hostUrl = window.location.host;
                    //if (dojoConfig.ppcServer.demoMode) {
                    if(false){
                        hostUrl = dojoConfig.ppcServer.demoLocalHost;
                    }

                    // ajax request URL, less command and parameters
                    var baseAjaxUrl = window.location.protocol + '//' + hostUrl + '/' + handlerPath;

                    var loadResourceSelect = function () {
                        var resourceId = '0';

                        var queryStr = window.location.search;
                        if (queryStr) {
                            var query = queryStr.substring(queryStr.indexOf("?") + 1, queryStr.length);
                            query = ioQuery.queryToObject(query);
                            if (query && query.quad) {
                                var resourceId = query.quad;
                            }
                        }

						//Can't use this if there is no left pane containing resource selector
						/*
                        var rsp = registry.byId('resourceSelect');
                        rsp.load(baseAjaxUrl, resourceId, resourceServer); */
						
						/*Instead call panel loader directly*/
						loadPanels();
                    };

                    var loadIoPanel = function () {
                        var iop = registry.byId('ioPanel');
                        iop.unload();
                        iop.load(baseAjaxUrl, SelectedServerId, ioServer);
                    };

                    var unloadIoPanel = function () {
                        var iop = registry.byId('ioPanel');
                        iop.unload();
                    };

                    var loadDCServerPanel = function () {
                        var DCServerp = registry.byId('DCServerPanel');
                        DCServerp.unload();
                        DCServerp.load(baseAjaxUrl, SelectedServerId, dcServer);
                    };

                    var unloadDCServerPanel = function () {
                        var DCServerp = registry.byId('DCServerPanel');
                        DCServerp.unload();
                    };

                    var loadLoadServerPanel = function () {
                        var LoadServerp = registry.byId('LoadServerPanel');
                        //LoadServerp.unload();
                        LoadServerp.load(baseAjaxUrl, SelectedServerId, loadServer);
                    };

                    var unloadLoadServerPanel = function () {
                        var LoadServerp = registry.byId('LoadServerPanel');
                        LoadServerp.unload();
                    };
					
					

                    var loadPanels = function () {
                        switch (SelectedTabName) {
                            case 'ioTab':
                                /*
                                unloadDCServerPanel();
								unloadLoadServerPanel();
								*/
                                loadIoPanel();
                                break;
                            /*
                            case 'DCServerTab':
                                unloadIoPanel();
								unloadLoadServerPanel();
                                loadDCServerPanel();
                                break;

							case 'LoadServerTab':
								unloadDCServerPanel();
                                unloadIoPanel();
                                loadLoadServerPanel();
								break;
							*/
                            default:
                                break;
                        }
                    };

                    var selectMainPanel = function (/*string*/resourceId, /*string*/resourceName, /*bool*/isMaster, /*bool*/subsysLocked) {
                        SelectedServerId = resourceId;
                        // reload panel on selected tab
                        var tabs = registry.byId("stack");
                        SelectedTabName = tabs.selectedChildWidget.id;

                        loadPanels();
                    };
                    
                    // load actions
                    dom.byId('pbResourceName').innerHTML = _machine_name;
                    topic.subscribe(PubSub.selectResource, selectMainPanel);
                    loadResourceSelect();

                    // connect panel loaders to tab select event
                    var tabs = registry.byId('stack');
                    aspect.after(tabs, 'selectChild', lang.hitch(this, function (child) {
                        SelectedTabName = child.id;
                        loadPanels();
                    }), true);
                });
            });
        });
    </script>
</body>
</html>
